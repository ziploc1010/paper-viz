<svg viewBox="0 0 900 2345" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 6 3, 0 6" fill="#333"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 6 3, 0 6" fill="#ff4444"/>
    </marker>
  </defs>

  <!-- Main Container -->
  <rect x="80" y="40" width="740" height="2330" fill="#f0ebff" stroke="#999" stroke-width="1.2" rx="8"/>
  <text x="450" y="65" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold">DeepSeekV3</text>
  <text x="450" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666" font-style="italic">MoE Transformer</text>

  <!-- Input Tokens -->
  <rect x="350" y="110" width="200" height="40" fill="#ffb3ba" stroke="#666" stroke-width="1.2" rx="20"/>
  <text x="450" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="500">Input Tokens</text>
  <text x="450" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">[batch, seq_len]</text>

  <line x1="450" y1="150" x2="450" y2="180" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Token Embedding -->
  <rect x="225" y="180" width="450" height="40" fill="#c9b3ff" stroke="#666" stroke-width="1.2" rx="5"/>
  <text x="450" y="198" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="500">Embedding</text>
  <text x="450" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">embedding</text>
  <text x="340" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">vocab_size × hidden_dim</text>

  <line x1="450" y1="220" x2="450" y2="240" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Embedding Dropout -->
  <rect x="300" y="240" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="258" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">dropout</text>
  <text x="450" y="267" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">embedding_dropout</text>

  <line x1="450" y1="270" x2="450" y2="285" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- N-layers iteration marker (outside container) -->
  <rect x="100" y="305" width="22" height="1730" fill="#ffd9b3" stroke="#666" stroke-width="1" rx="3"/>
  <text x="111" y="1170" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="600" transform="rotate(-90 111 1170)">× num_layers</text>

  <!-- Transformer Layer Container -->
  <rect x="135" y="285" width="640" height="1770" fill="#e6d9ff" stroke="#888" stroke-width="1.5" rx="8"/>
  <text x="450" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold">Transformer Layer</text>
  <text x="450" y="327" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666" font-style="italic">(× num_layers)</text>

  <!-- First residual branch point -->
  <rect x="300" y="355" width="300" height="30" fill="#ffd9b3" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="375" text-anchor="middle" font-family="Arial, sans-serif" font-size="11">shortcut = x</text>

  <line x1="450" y1="385" x2="450" y2="415" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- LayerNorm 1 -->
  <rect x="300" y="415" width="300" height="35" fill="#ffe0b3" stroke="#666" stroke-width="1.5" rx="5"/>
  <text x="450" y="435" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="600">LayerNorm</text>
  <text x="450" y="445" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">attn_norm</text>

  <line x1="450" y1="450" x2="450" y2="470" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Center and shift normalization -->
  <rect x="300" y="470" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="487" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">center &amp; shift</text>
  <text x="450" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">x - mean(x) + 1.0</text>

  <line x1="450" y1="500" x2="450" y2="525" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- MultiHeadLatentAttention Container -->
  <rect x="170" y="525" width="560" height="780" fill="#ffd6cc" stroke="#999" stroke-width="1" rx="6" fill-opacity="0.5"/>
  <text x="450" y="543" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold">MultiHeadLatentAttention (MLA)</text>
  <text x="450" y="557" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666" font-style="italic">attention</text>

  <!-- KV Compression Path (Left) -->
  <rect x="235" y="580" width="130" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="300" y="593" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="500">Linear</text>
  <text x="300" y="603" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">kv_down</text>
  <text x="300" y="611" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">→ kv_compression_dim</text>

  <!-- Query Compression Path (Right) -->
  <rect x="535" y="580" width="130" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="600" y="593" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="500">Linear</text>
  <text x="600" y="603" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">query_down</text>
  <text x="600" y="611" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">→ query_compression_dim</text>

  <!-- KV Uprojections (Left side - 3 boxes) -->
  <rect x="210" y="640" width="90" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="255" y="653" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="500">key_up</text>
  <text x="255" y="663" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">n_heads×h_dim</text>

  <rect x="310" y="640" width="90" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="355" y="653" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="500">value_up</text>
  <text x="355" y="663" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">n_heads×h_dim</text>

  <rect x="405" y="640" width="90" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="653" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="500">key_rope</text>
  <text x="450" y="663" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">n_heads×rope_dim</text>

  <!-- Query Uprojections (Right side - 2 boxes) -->
  <rect x="505" y="640" width="90" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="550" y="653" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="500">query_up</text>
  <text x="550" y="663" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">n_heads×h_dim</text>

  <rect x="600" y="640" width="90" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="645" y="653" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="500">query_rope</text>
  <text x="645" y="663" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">n_heads×rope_dim</text>

  <!-- Connections from compression to uprojections -->
  <line x1="300" y1="615" x2="255" y2="640" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="300" y1="615" x2="355" y2="640" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="300" y1="615" x2="450" y2="640" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="600" y1="615" x2="550" y2="640" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="600" y1="615" x2="645" y2="640" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- View & Transpose -->
  <rect x="300" y="700" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="717" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">view &amp; transpose</text>

  <!-- Converging connections -->
  <line x1="255" y1="675" x2="350" y2="700" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="355" y1="675" x2="400" y2="700" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="450" y1="675" x2="450" y2="700" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="550" y1="675" x2="500" y2="700" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="645" y1="675" x2="550" y2="700" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <line x1="450" y1="730" x2="450" y2="755" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Apply RoPE -->
  <rect x="300" y="755" width="300" height="35" fill="#bfffbf" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="768" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="500">apply RoPE</text>
  <text x="450" y="780" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">queries_rope, keys_rope</text>

  <line x1="450" y1="790" x2="450" y2="815" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Concatenate -->
  <rect x="300" y="815" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">concatenate</text>
  <text x="450" y="840" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">cat([queries_c, queries_r], [keys_c, keys_r])</text>

  <line x1="450" y1="845" x2="450" y2="870" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Matmul -->
  <rect x="300" y="860" width="300" height="30" fill="#bfffbf" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="873" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">matmul</text>
  <text x="450" y="883" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">queries @ keys.transpose</text>

  <line x1="450" y1="890" x2="450" y2="910" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Masked fill (causal + optional) -->
  <rect x="300" y="910" width="300" height="35" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="923" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">masked_fill</text>
  <text x="450" y="933" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">causal mask + attention_mask → -1e9</text>

  <line x1="450" y1="945" x2="450" y2="965" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Scale -->
  <rect x="300" y="965" width="300" height="25" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="978" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">scale</text>
  <text x="450" y="986" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">/ √(head_dim + rope_dim)</text>

  <line x1="450" y1="990" x2="450" y2="1005" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Softmax -->
  <rect x="300" y="1005" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1018" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">softmax</text>
  <text x="450" y="1028" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">attention probabilities</text>

  <line x1="450" y1="1035" x2="450" y2="1050" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Dropout -->
  <rect x="300" y="1050" width="300" height="25" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1065" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">dropout</text>

  <line x1="450" y1="1075" x2="450" y2="1090" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Weighted sum -->
  <rect x="300" y="1090" width="300" height="30" fill="#bfffbf" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1103" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">matmul</text>
  <text x="450" y="1113" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">attn_probs @ values</text>

  <line x1="450" y1="1120" x2="450" y2="1140" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Transpose & reshape -->
  <rect x="300" y="1140" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">transpose &amp; reshape</text>

  <line x1="450" y1="1170" x2="450" y2="1195" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Output projection -->
  <rect x="300" y="1195" width="300" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1.2" rx="5"/>
  <text x="450" y="1213" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="500">Linear</text>
  <text x="450" y="1223" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">output_proj</text>

  <line x1="450" y1="1230" x2="450" y2="1250" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Dropout -->
  <rect x="300" y="1250" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1268" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">dropout</text>

  <!-- Arrow from MLA container to residual -->
  <line x1="450" y1="1305" x2="450" y2="1332" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Add residual 1 -->
  <circle cx="450" cy="1350" r="18" fill="#ffcc99" stroke="#666" stroke-width="1.5"/>
  <text x="450" y="1356" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold">+</text>

  <!-- First residual connection -->
  <path d="M 300 370 L 150 370 L 150 1350 L 432 1350" stroke="#ff4444" stroke-width="1" stroke-dasharray="8,4" fill="none" marker-end="url(#arrowhead-red)"/>

  <line x1="450" y1="1368" x2="450" y2="1393" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Second residual branch point -->
  <rect x="300" y="1395" width="300" height="30" fill="#ffd9b3" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1413" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">shortcut = x</text>

  <line x1="450" y1="1425" x2="450" y2="1450" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- LayerNorm 2 -->
  <rect x="300" y="1450" width="300" height="35" fill="#ffcc99" stroke="#666" stroke-width="1.2" rx="5"/>
  <text x="450" y="1468" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="500">LayerNorm</text>
  <text x="450" y="1478" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">moe_norm</text>

  <line x1="450" y1="1485" x2="450" y2="1510" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- DeepSeekMoE Container -->
  <rect x="190" y="1510" width="520" height="470" fill="#ffd6cc" stroke="#999" stroke-width="1" rx="6" fill-opacity="0.5"/>
  <text x="450" y="1548" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold">DeepSeekMoE (Mixture of Experts)</text>
  <text x="450" y="1562" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666" font-style="italic">moe</text>

  <!-- Gate -->
  <rect x="300" y="1585" width="300" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1600" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="500">Linear (Gate)</text>
  <text x="450" y="1610" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">gate</text>
  <text x="450" y="1617" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">hidden_dim → num_experts</text>

  <line x1="450" y1="1620" x2="450" y2="1640" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Sigmoid + Bias -->
  <rect x="300" y="1640" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1655" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">sigmoid + bias</text>
  <text x="450" y="1663" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">routing scores with load balancing</text>

  <line x1="450" y1="1670" x2="450" y2="1690" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Top-k Selection -->
  <rect x="300" y="1690" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1705" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">topk selection</text>
  <text x="450" y="1713" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">select top_k experts</text>

  <line x1="450" y1="1720" x2="450" y2="1740" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Normalize scores -->
  <rect x="300" y="1740" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1755" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">normalize scores</text>
  <text x="450" y="1763" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">sum to 1</text>

  <!-- Routed Experts -->
  <rect x="240" y="1790" width="180" height="50" fill="#d9f0ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="330" y="1803" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="500">ExpertFFN (routed)</text>
  <text x="330" y="1814" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666" font-style="italic">experts[i]</text>
  <text x="330" y="1825" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">up → GELU → dropout → down</text>
  <text x="330" y="1834" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">weighted by routing scores</text>

  <!-- Shared Expert -->
  <rect x="480" y="1790" width="180" height="50" fill="#d9f0ff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="570" y="1803" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="500">ExpertFFN (shared)</text>
  <text x="570" y="1814" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666" font-style="italic">shared_expert</text>
  <text x="570" y="1825" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">up → GELU → dropout → down</text>
  <text x="570" y="1834" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#888">scaled by 0.1</text>

  <!-- Connections to experts (split from normalize scores) -->
  <line x1="450" y1="1770" x2="330" y2="1790" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="450" y1="1770" x2="570" y2="1790" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Combine outputs -->
  <circle cx="450" cy="1880" r="18" fill="#ffcc99" stroke="#666" stroke-width="1.5"/>
  <text x="450" y="1886" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold">+</text>

  <line x1="330" y1="1840" x2="430" y2="1880" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="570" y1="1840" x2="470" y2="1880" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <line x1="450" y1="1900" x2="450" y2="1925" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Dropout -->
  <rect x="300" y="1925" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="1943" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">dropout</text>

  <!-- Close MoE -->
  <line x1="450" y1="1980" x2="450" y2="2007" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Add residual 2 -->
  <circle cx="450" cy="2025" r="18" fill="#ffd9b3" stroke="#666" stroke-width="1.5"/>
  <text x="450" y="2031" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold">+</text>

  <!-- Second residual connection -->
  <path d="M 300 1410 L 150 1410 L 150 2025 L 432 2025" stroke="#ff4444" stroke-width="1" stroke-dasharray="8,4" fill="none" marker-end="url(#arrowhead-red)"/>

  <!-- Arrow from Transformer layer to Final norm -->
  <line x1="450" y1="2055" x2="450" y2="2080" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Final LayerNorm -->
  <rect x="300" y="2080" width="300" height="35" fill="#ffe0b3" stroke="#666" stroke-width="1.5" rx="5"/>
  <text x="450" y="2100" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="600">LayerNorm</text>
  <text x="450" y="2110" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">final_norm</text>

  <line x1="450" y1="2115" x2="450" y2="2140" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Dropout -->
  <rect x="300" y="2135" width="300" height="30" fill="#ffcc99" stroke="#666" stroke-width="1" rx="5"/>
  <text x="450" y="2153" text-anchor="middle" font-family="Arial, sans-serif" font-size="10">dropout</text>
  <text x="450" y="2162" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">final_dropout</text>

  <!-- Split to both paths -->
  <line x1="325" y1="2165" x2="325" y2="2190" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="575" y1="2165" x2="575" y2="2190" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Output Head (Left) -->
  <rect x="200" y="2190" width="240" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1.5" rx="5"/>
  <text x="320" y="2205" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600">Linear</text>
  <text x="320" y="2217" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666" font-style="italic">output_head</text>

  <!-- Multi-Token Prediction (Right) -->
  <rect x="460" y="2190" width="240" height="35" fill="#b3d9ff" stroke="#666" stroke-width="1.5" rx="5"/>
  <text x="580" y="2205" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600">MultiTokenPrediction</text>
  <text x="580" y="2217" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666" font-style="italic">mtp</text>

  <!-- Arrows to outputs -->
  <line x1="320" y1="2225" x2="320" y2="2255" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="580" y1="2225" x2="580" y2="2255" stroke="#333" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Output labels -->
  <rect x="200" y="2255" width="240" height="40" fill="#c8f5c8" stroke="#666" stroke-width="1.5" rx="20"/>
  <text x="320" y="2273" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="600">logits</text>
  <text x="320" y="2285" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">[batch, seq_len, vocab_size]</text>

  <rect x="460" y="2255" width="240" height="40" fill="#c8f5c8" stroke="#666" stroke-width="1.5" rx="20"/>
  <text x="580" y="2273" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="600">mtp_outputs</text>
  <text x="580" y="2285" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">[batch, depth, seq_len, vocab_size]</text>

  <!-- Return tuple annotation -->
  <text x="450" y="2315" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666" font-style="italic">return (logits, mtp_outputs)</text>

</svg>
